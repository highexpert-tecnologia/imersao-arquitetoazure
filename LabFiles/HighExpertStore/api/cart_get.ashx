<%@ WebHandler Language="C#" Class="ApiCartGet" %>
using System;using System.Data.SqlClient;using System.Web;using HighExpertStore;
public class ApiCartGet:IHttpHandler{
public void ProcessRequest(HttpContext c){c.Response.ContentType="application/json";try{
string token=c.Request["token"]??"";using(var conn=Db.GetConnection()){conn.Open();var uid=Db.ValidateToken(token,conn);if(uid==null){c.Response.StatusCode=401;c.Response.Write(Db.Json(new{error="Token inv√°lido"}));return;}
int cartId;using(var cmd=new SqlCommand(@"IF NOT EXISTS(SELECT 1 FROM Carts WHERE UserId=@u AND Status='Active') INSERT INTO Carts(UserId,Status) OUTPUT INSERTED.Id VALUES(@u,'Active') ELSE SELECT TOP 1 Id FROM Carts WHERE UserId=@u AND Status='Active' ORDER BY Id DESC",conn)){cmd.Parameters.AddWithValue("@u",uid.Value);cartId=Convert.ToInt32(cmd.ExecuteScalar());}
using(var q=new SqlCommand(@"SELECT ci.Id,p.Id,p.Name,p.Price,ci.Quantity,p.ImageUrl FROM CartItems ci JOIN Products p ON p.Id=ci.ProductId WHERE ci.CartId=@c",conn)){q.Parameters.AddWithValue("@c",cartId);using(var r=q.ExecuteReader()){var items=new System.Collections.Generic.List<object>();decimal total=0m;while(r.Read()){var qnt=r.GetInt32(4);var price=Math.Round(r.GetDecimal(3),2);total+=price*qnt;items.Add(new{id=r.GetInt32(0),productId=r.GetInt32(1),name=r.GetString(2),price=price,quantity=qnt,imageUrl=r.IsDBNull(5)?"":r.GetString(5)});}c.Response.Write(Db.Json(new{cartId=cartId,items=items,total=Math.Round(total,2)}));}}}}catch(Exception ex){c.Response.StatusCode=500;c.Response.Write(Db.Json(new{error=ex.Message}));}}public bool IsReusable{get{return false;}}}